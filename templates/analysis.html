<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>品牌比較 - 飲料社群粉絲專頁分析</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 引入Plotly.js用於互動式圖表 -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- 添加Font Awesome圖標 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <h1>飲料品牌社群表現比較</h1>
        <nav>
            <ul>
                <li><a href="/"><i class="fas fa-home"></i> 首頁</a></li>
                <li><a href="/analysis" class="active"><i class="fas fa-chart-bar"></i> 品牌比較</a></li>
                <li><a href="/visualization"><i class="fas fa-chart-line"></i> 視覺化分析</a></li>
            </ul>
        </nav>
    </header>

    <main class="analysis-content">
        <section class="section-intro">
            <h2><i class="fas fa-exchange-alt"></i> 互動數據分析</h2>
            <p>本頁面比較了各家飲料品牌在社群媒體上的互動表現。下方圖表呈現了不同品牌的互動數據統計和比較。</p>
        </section>

        <section class="chart-section">
            <h3><i class="fas fa-clipboard-list"></i> 各品牌貼文總數比較</h3>
            <div id="post-count-chart" class="chart-container"></div>
            <p class="chart-description">各品牌在觀測期間內發布的貼文數量比較</p>
        </section>

        <section class="chart-section">
            <h3><i class="fas fa-users"></i> 各品牌互動量比較</h3>
            <div id="total-interactions-chart" class="chart-container"></div>
            <p class="chart-description">各品牌獲得的總互動數（按讚+留言+分享）比較</p>
        </section>

        <section class="chart-section">
            <h3><i class="fas fa-chart-pie"></i> 平均每貼文互動類型比較</h3>
            <div id="avg-engagement-chart" class="chart-container"></div>
            <p class="chart-description">各品牌平均每則貼文獲得的按讚、留言、分享數量</p>
        </section>

        <section class="chart-section">
            <h3><i class="fas fa-chart-line"></i> 互動效率比較</h3>
            <div id="interaction-rate-chart" class="chart-container"></div>
            <p class="chart-description">各品牌的互動率比較（平均互動分數/1000）</p>
        </section>

        <section class="insights">
            <h3><i class="fas fa-lightbulb"></i> 主要發現</h3>
            <ul id="insights-list">
                <li>載入中...</li>
            </ul>
        </section>
    </main>

    <footer>
        <p>&copy; 飲料社群粉絲專頁分析 | 機器學習概論專案</p>
        <div class="footer-links">
            <a href="#"><i class="fas fa-code"></i> GitHub</a>
            <a href="#"><i class="fas fa-book"></i> 專案報告</a>
        </div>
    </footer>

    <script>
        // 設定Plotly深色主題（全域變數）
        const darkTemplate = {
            paper_bgcolor: '#252525',
            plot_bgcolor: '#252525',
            font: {
                color: '#e8e8e8'
            },
            xaxis: {
                gridcolor: 'rgba(255, 255, 255, 0.1)',
                zerolinecolor: 'rgba(255, 255, 255, 0.1)'
            },
            yaxis: {
                gridcolor: 'rgba(255, 255, 255, 0.1)',
                zerolinecolor: 'rgba(255, 255, 255, 0.1)'
            },
            legend: {
                bgcolor: '#252525'
            }
        };
        
        // 創建錯誤訊息
        function createErrorMessage(title, message, retryFunction) {
            return `<div class="error-container">
                <p class="error"><i class="fas fa-exclamation-triangle"></i> ${title}：${message}</p>
                <button class="retry-btn" onclick="${retryFunction}">
                    <i class="fas fa-redo"></i> 重試
                </button>
            </div>`;
        }

        // 獲取品牌統計數據
        function fetchBrandStats() {
            return fetch('/api/brand_stats')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error(`HTTP 錯誤 ${response.status}`);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!data || Object.keys(data).length === 0) {
                        throw new Error('沒有可用的品牌數據');
                    }
                    return data;
                });
        }

        // 獲取互動比較數據
        function fetchEngagementComparison() {
            return fetch('/api/engagement_comparison')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error(`HTTP 錯誤 ${response.status}`);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!data || !data.brands || data.brands.length === 0) {
                        throw new Error('沒有可用的互動比較數據');
                    }
                    return data;
                });
        }
        
        // 渲染貼文數量比較圖
        function renderPostCountChart(data) {
            try {
                // 先清空容器，移除載入訊息
                document.getElementById('post-count-chart').innerHTML = '';
                
                const brands = Object.keys(data);
                const postCounts = brands.map(function(brand) {
                    return data[brand].post_count;
                });

                const trace = {
                    x: brands,
                    y: postCounts,
                    type: 'bar',
                    marker: {
                        color: '#4fa8ff',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1.5
                        }
                    }
                };

                const layout = {
                    title: '各品牌貼文數量',
                    xaxis: {
                        title: '品牌',
                        gridcolor: darkTemplate.xaxis.gridcolor,
                        zerolinecolor: darkTemplate.xaxis.zerolinecolor
                    },
                    yaxis: {
                        title: '貼文數量',
                        gridcolor: darkTemplate.yaxis.gridcolor,
                        zerolinecolor: darkTemplate.yaxis.zerolinecolor
                    },
                    paper_bgcolor: darkTemplate.paper_bgcolor,
                    plot_bgcolor: darkTemplate.plot_bgcolor,
                    font: darkTemplate.font
                };

                Plotly.newPlot('post-count-chart', [trace], layout);
            } catch (error) {
                console.error('渲染貼文數量圖表失敗:', error);
                document.getElementById('post-count-chart').innerHTML = createErrorMessage('無法渲染貼文數量圖表', error.message, 'fetchBrandStats()');
            }
        }

        // 渲染總互動量比較圖
        function renderTotalInteractionsChart(data) {
            try {
                // 先清空容器，移除載入訊息
                document.getElementById('total-interactions-chart').innerHTML = '';
                
                const brands = Object.keys(data);
                const likes = brands.map(function(brand) {
                    return data[brand].total_likes;
                });
                const comments = brands.map(function(brand) {
                    return data[brand].total_comments;
                });
                const shares = brands.map(function(brand) {
                    return data[brand].total_shares;
                });

                const trace1 = {
                    x: brands,
                    y: likes,
                    name: '按讚',
                    type: 'bar',
                    marker: {
                        color: '#4fa8ff',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1
                        }
                    }
                };

                const trace2 = {
                    x: brands,
                    y: comments,
                    name: '留言',
                    type: 'bar',
                    marker: {
                        color: '#ff6b9d',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1
                        }
                    }
                };

                const trace3 = {
                    x: brands,
                    y: shares,
                    name: '分享',
                    type: 'bar',
                    marker: {
                        color: '#4caf50',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1
                        }
                    }
                };

                const layout = {
                    title: '各品牌總互動量',
                    barmode: 'stack',
                    xaxis: {
                        title: '品牌',
                        gridcolor: darkTemplate.xaxis.gridcolor,
                        zerolinecolor: darkTemplate.xaxis.zerolinecolor
                    },
                    yaxis: {
                        title: '互動數量',
                        gridcolor: darkTemplate.yaxis.gridcolor,
                        zerolinecolor: darkTemplate.yaxis.zerolinecolor
                    },
                    paper_bgcolor: darkTemplate.paper_bgcolor,
                    plot_bgcolor: darkTemplate.plot_bgcolor,
                    font: darkTemplate.font,
                    legend: darkTemplate.legend
                };

                Plotly.newPlot('total-interactions-chart', [trace1, trace2, trace3], layout);
            } catch (error) {
                console.error('渲染總互動量圖表失敗:', error);
                document.getElementById('total-interactions-chart').innerHTML = createErrorMessage('無法渲染總互動量圖表', error.message, 'fetchBrandStats()');
            }
        }

        // 渲染平均每貼文互動類型比較圖
        function renderAvgEngagementChart(data) {
            try {
                // 先清空容器，移除載入訊息
                document.getElementById('avg-engagement-chart').innerHTML = '';
                
                const trace1 = {
                    x: data.brands,
                    y: data.likes,
                    name: '按讚',
                    type: 'bar',
                    marker: {
                        color: '#4fa8ff',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1
                        }
                    }
                };

                const trace2 = {
                    x: data.brands,
                    y: data.comments,
                    name: '留言',
                    type: 'bar',
                    marker: {
                        color: '#ff6b9d',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1
                        }
                    }
                };

                const trace3 = {
                    x: data.brands,
                    y: data.shares,
                    name: '分享',
                    type: 'bar',
                    marker: {
                        color: '#4caf50',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1
                        }
                    }
                };

                const layout = {
                    title: '各品牌平均每貼文互動類型',
                    barmode: 'group',
                    xaxis: {
                        title: '品牌',
                        gridcolor: darkTemplate.xaxis.gridcolor,
                        zerolinecolor: darkTemplate.xaxis.zerolinecolor
                    },
                    yaxis: {
                        title: '平均互動數量',
                        gridcolor: darkTemplate.yaxis.gridcolor,
                        zerolinecolor: darkTemplate.yaxis.zerolinecolor
                    },
                    paper_bgcolor: darkTemplate.paper_bgcolor,
                    plot_bgcolor: darkTemplate.plot_bgcolor,
                    font: darkTemplate.font,
                    legend: darkTemplate.legend
                };

                Plotly.newPlot('avg-engagement-chart', [trace1, trace2, trace3], layout);
            } catch (error) {
                console.error('渲染平均互動圖表失敗:', error);
                document.getElementById('avg-engagement-chart').innerHTML = createErrorMessage('無法渲染平均互動圖表', error.message, 'fetchEngagementComparison()');
            }
        }

        // 渲染互動率比較圖
        function renderInteractionRateChart(data) {
            try {
                // 先清空容器，移除載入訊息
                document.getElementById('interaction-rate-chart').innerHTML = '';
                
                const brands = Object.keys(data);
                const rates = brands.map(function(brand) {
                    return data[brand].avg_interactions_per_post;
                });

                const trace = {
                    x: brands,
                    y: rates,
                    type: 'bar',
                    marker: {
                        color: '#ff9800',
                        line: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            width: 1.5
                        }
                    }
                };

                const layout = {
                    title: '各品牌平均每貼文互動分數',
                    xaxis: {
                        title: '品牌',
                        gridcolor: darkTemplate.xaxis.gridcolor,
                        zerolinecolor: darkTemplate.xaxis.zerolinecolor
                    },
                    yaxis: {
                        title: '平均互動分數',
                        gridcolor: darkTemplate.yaxis.gridcolor,
                        zerolinecolor: darkTemplate.yaxis.zerolinecolor
                    },
                    paper_bgcolor: darkTemplate.paper_bgcolor,
                    plot_bgcolor: darkTemplate.plot_bgcolor,
                    font: darkTemplate.font
                };

                Plotly.newPlot('interaction-rate-chart', [trace], layout);
            } catch (error) {
                console.error('渲染互動率圖表失敗:', error);
                document.getElementById('interaction-rate-chart').innerHTML = createErrorMessage('無法渲染互動率圖表', error.message, 'fetchBrandStats()');
            }
        }
        
        // 頁面載入後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 設定載入中的訊息
            document.querySelectorAll('.chart-container').forEach(container => {
                container.innerHTML = '<div class="loading-message"><i class="fas fa-spinner fa-spin"></i> 正在載入數據...</div>';
            });
            
            document.getElementById('insights-list').innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> 載入中...</li>';
            
            // 載入品牌數據
            fetchBrandStats()
                .then(function(data) {
                    renderPostCountChart(data);
                    renderTotalInteractionsChart(data);
                    renderInteractionRateChart(data);
                    generateInsights(data);
                })
                .catch(function(error) {
                    console.error('獲取品牌數據失敗:', error);
                    document.getElementById('post-count-chart').innerHTML = createErrorMessage('無法載入貼文數量圖表', error.message, 'fetchBrandStats()');
                    document.getElementById('total-interactions-chart').innerHTML = createErrorMessage('無法載入總互動量圖表', error.message, 'fetchBrandStats()');
                    document.getElementById('interaction-rate-chart').innerHTML = createErrorMessage('無法載入互動效率圖表', error.message, 'fetchBrandStats()');
                    document.getElementById('insights-list').innerHTML = '<li><i class="fas fa-exclamation-triangle"></i> 無法載入洞察數據</li>';
                });
            
            // 載入互動比較數據
            fetchEngagementComparison()
                .then(function(data) {
                    renderAvgEngagementChart(data);
                })
                .catch(function(error) {
                    console.error('獲取互動比較數據失敗:', error);
                    document.getElementById('avg-engagement-chart').innerHTML = createErrorMessage('無法載入平均互動圖表', error.message, 'fetchEngagementComparison()');
                });
        });

        // 生成洞察發現
        function generateInsights(data) {
            try {
                const brands = Object.keys(data);
                
                // 查找發文最多的品牌
                const mostPosts = brands.reduce(function(a, b) {
                    return data[a].post_count > data[b].post_count ? a : b;
                });
                
                // 查找總互動最高的品牌
                const mostInteractions = brands.reduce(function(a, b) {
                    return data[a].total_interactions > data[b].total_interactions ? a : b;
                });
                
                // 查找平均每貼文互動最高的品牌
                const mostEfficient = brands.reduce(function(a, b) {
                    return data[a].avg_interactions_per_post > data[b].avg_interactions_per_post ? a : b;
                });
                
                // 生成洞察列表
                const insights = [
                    `<i class="fas fa-crown"></i> ${mostPosts} 是發佈貼文最多的品牌，共有 ${data[mostPosts].post_count} 則貼文。`,
                    `<i class="fas fa-medal"></i> ${mostInteractions} 獲得的總互動量最高，共有 ${data[mostInteractions].total_interactions} 次互動。`,
                    `<i class="fas fa-trophy"></i> ${mostEfficient} 的平均每則貼文互動分數最高，達 ${data[mostEfficient].avg_interactions_per_post.toFixed(2)}，互動效率最佳。`,
                    `<i class="fas fa-chart-bar"></i> 平均來說，按讚是最常見的互動形式，其次是留言和分享。`
                ];
                
                // 更新洞察列表
                const insightsList = document.getElementById('insights-list');
                insightsList.innerHTML = '';
                insights.forEach(function(insight) {
                    const li = document.createElement('li');
                    li.innerHTML = insight;  // 使用innerHTML來呈現HTML圖標
                    insightsList.appendChild(li);
                });
            } catch (error) {
                console.error('生成洞察失敗:', error);
                document.getElementById('insights-list').innerHTML = '<li><i class="fas fa-exclamation-triangle"></i> 無法生成洞察數據</li>';
            }
        }
    </script>
</body>
</html> 